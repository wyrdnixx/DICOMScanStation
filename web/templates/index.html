<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .scanner-card {
            transition: all 0.3s ease;
        }
        .scanner-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .file-thumbnail {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .file-thumbnail:hover {
            transform: scale(1.05);
        }
        .modal-image {
            max-width: 100%;
            max-height: 80vh;
        }
        .status-connected {
            color: #28a745;
        }
        .status-disconnected {
            color: #dc3545;
        }
        .scanner-selected {
            background-color: #e3f2fd !important;
            border-color: #2196f3 !important;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Header -->
            <div class="col-12 bg-primary text-white p-3">
                <h1 class="mb-0">
                    <i class="fas fa-scanner"></i> {{.title}}
                </h1>
                <p class="mb-0">{{.config.WebDescription}}</p>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Scanner Status -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-scanner"></i> Scanner Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="scanners-container">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p>Loading scanners...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scan Control -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-camera"></i> Scan Control</h5>
                    </div>
                    <div class="card-body">
                        <div id="scan-control">
                            <div class="text-center">
                                <p>No connected scanners available</p>
                            </div>
                        </div>
                        
                        <!-- Scan Options (initially hidden) -->
                        <div id="scan-options" style="display: none;">
                            <hr>
                            <h6><i class="fas fa-cog"></i> Scan Options</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="multiPage" checked>
                                        <label class="form-check-label" for="multiPage">
                                            Multi-page scanning
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="duplex">
                                        <label class="form-check-label" for="duplex">
                                            Duplex (both sides)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="color" checked>
                                        <label class="form-check-label" for="color">
                                            Color scanning
                                        </label>
                                    </div>
                                    <div class="mb-3">
                                        <label for="resolution" class="form-label">Resolution (DPI)</label>
                                        <select class="form-select" id="resolution">
                                            <option value="150">150 DPI</option>
                                            <option value="300" selected>300 DPI</option>
                                            <option value="600">600 DPI</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scanned Files -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-images"></i> Scanned Files</h5>
                        <button class="btn btn-outline-danger btn-sm" onclick="clearAllFiles()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="files-container">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p>Loading files...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Document View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modal-image" class="modal-image" src="" alt="Document">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" onclick="deleteCurrentFile()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFiles = [];
        let currentFilename = '';
        let selectedScanner = '';

        let isScanning = false;
        let scannerRefreshInterval;
        let filesRefreshInterval;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadScanners();
            loadFiles();
            
            // Refresh data every 5 seconds
            scannerRefreshInterval = setInterval(loadScanners, 5000);
            filesRefreshInterval = setInterval(loadFiles, 5000);
        });

        function loadScanners() {
            fetch('/api/scanners')
                .then(response => response.json())
                .then(data => {
                    updateScannersUI(data.scanners);
                })
                .catch(error => {
                    console.error('Error loading scanners:', error);
                });
        }

        function updateScannersUI(scanners) {
            const container = document.getElementById('scanners-container');
            const scanControl = document.getElementById('scan-control');
            
            if (scanners.length === 0) {
                container.innerHTML = '<p class="text-muted">No scanners detected</p>';
                scanControl.innerHTML = '<p class="text-muted">No connected scanners available</p>';
                return;
            }

            let scannersHTML = '';
            let scanControlHTML = '';
            let connectedScanners = [];

            scanners.forEach(scanner => {
                const statusClass = scanner.connected ? 'status-connected' : 'status-disconnected';
                const statusIcon = scanner.connected ? 'fa-check-circle' : 'fa-times-circle';
                const isSelected = selectedScanner === scanner.device;
                const selectedClass = isSelected ? 'scanner-selected' : '';
                
                scannersHTML += `
                    <div class="scanner-card card mb-3 ${selectedClass}" onclick="selectScanner('${scanner.device}')" style="cursor: pointer;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${scanner.name}</h6>
                                    <small class="text-muted">${scanner.device}</small>
                                </div>
                                <div class="text-end">
                                    <i class="fas ${statusIcon} ${statusClass}"></i>
                                    <br>
                                    <small class="text-muted">${scanner.status}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                if (scanner.connected) {
                    connectedScanners.push(scanner);
                }
            });

            // Generate scan control based on connected scanners
            if (connectedScanners.length === 0) {
                scanControlHTML = '<p class="text-muted text-center">No connected scanners available</p>';
                document.getElementById('scan-options').style.display = 'none';
            } else if (connectedScanners.length === 1) {
                const scanner = connectedScanners[0];
                const isSelected = selectedScanner === scanner.device;
                const buttonClass = isSelected ? 'btn-primary' : 'btn-outline-primary';
                const buttonText = isSelected ? 'Selected Scanner' : 'Select Scanner';
                
                scanControlHTML = `
                    <div class="text-center">
                        <p>Ready to scan with: <strong>${scanner.name}</strong></p>
                        <button class="btn ${buttonClass} btn-lg" onclick="startScan('${scanner.device}')">
                            <i class="fas fa-camera"></i> ${buttonText}
                        </button>
                    </div>
                `;
                
                if (isSelected) {
                    document.getElementById('scan-options').style.display = 'block';
                } else {
                    document.getElementById('scan-options').style.display = 'none';
                }
            } else {
                // Multiple connected scanners
                const selectedScannerObj = connectedScanners.find(s => s.device === selectedScanner);
                if (selectedScannerObj) {
                    scanControlHTML = `
                        <div class="text-center">
                            <p>Selected scanner: <strong>${selectedScannerObj.name}</strong></p>
                            <button class="btn btn-primary btn-lg" onclick="startScan('${selectedScannerObj.device}')">
                                <i class="fas fa-camera"></i> Start Scan
                            </button>
                        </div>
                    `;
                    document.getElementById('scan-options').style.display = 'block';
                } else {
                    scanControlHTML = `
                        <div class="text-center">
                            <p class="text-muted">Click on a scanner above to select it</p>
                            <button class="btn btn-outline-secondary btn-lg" disabled>
                                <i class="fas fa-camera"></i> Select Scanner First
                            </button>
                        </div>
                    `;
                    document.getElementById('scan-options').style.display = 'none';
                }
            }

            container.innerHTML = scannersHTML;
            if (scanControlHTML) {
                scanControl.innerHTML = scanControlHTML;
            }
        }

        function loadFiles() {
            fetch('/api/files')
                .then(response => response.json())
                .then(data => {
                    currentFiles = data.files;
                    updateFilesUI(data.files);
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                });
        }

        function updateFilesUI(files) {
            const container = document.getElementById('files-container');
            
            if (isScanning) {
                container.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Scanning...</span>
                        </div>
                        <p class="mt-2">Scanning in progress...</p>
                    </div>
                `;
                return;
            }
            
            if (files.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No scanned files found</p>';
                return;
            }

            let filesHTML = '<div class="row">';
            files.forEach(file => {
                filesHTML += `
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <img src="/api/files/${file.name}" 
                                     class="file-thumbnail mb-2" 
                                     onclick="viewImage('${file.name}')"
                                     alt="${file.name}">
                                <h6 class="card-title">${file.name}</h6>
                                <p class="card-text">
                                    <small class="text-muted">
                                        ${formatFileSize(file.size)}<br>
                                        ${file.modified_time}
                                    </small>
                                </p>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteFile('${file.name}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            filesHTML += '</div>';
            container.innerHTML = filesHTML;
        }

        function selectScanner(device) {
            selectedScanner = device;
            loadScanners(); // Refresh the UI to show selection
            
            // Show scan options when a scanner is selected
            const scanOptions = document.getElementById('scan-options');
            if (scanOptions) {
                scanOptions.style.display = 'block';
            }
        }

        function startScan(device) {
            // Auto-select the scanner if none is selected
            if (!selectedScanner && device) {
                selectedScanner = device;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
            
            // Pause auto-refresh during scanning
            isScanning = true;
            clearInterval(filesRefreshInterval);

            // Get scan options
            const options = {
                multi_page: document.getElementById('multiPage').checked,
                duplex: document.getElementById('duplex').checked,
                color: document.getElementById('color').checked,
                resolution: parseInt(document.getElementById('resolution').value)
            };

            fetch('/api/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    device: device,
                    options: options
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Scan failed: ' + data.error);
                } else {
                    const pageText = data.pages === 1 ? 'page' : 'pages';
                    alert(`Scan completed successfully! Scanned ${data.pages} ${pageText}.`);
                    // Add a delay to ensure files are fully written before refreshing
                    setTimeout(() => {
                        loadFiles();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Scan failed: ' + error.message);
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalText;
                
                // Resume auto-refresh after scanning
                isScanning = false;
                filesRefreshInterval = setInterval(loadFiles, 5000);
            });
        }

        function viewImage(filename) {
            currentFilename = filename;
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            document.getElementById('modal-image').src = `/api/files/${filename}`;
            modal.show();
        }

        function deleteFile(filename) {
            if (confirm('Are you sure you want to delete this file?')) {
                fetch(`/api/files/${filename}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Delete failed: ' + data.error);
                    } else {
                        loadFiles();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Delete failed: ' + error.message);
                });
            }
        }

        function deleteCurrentFile() {
            if (currentFilename) {
                deleteFile(currentFilename);
                bootstrap.Modal.getInstance(document.getElementById('imageModal')).hide();
            }
        }

        function clearAllFiles() {
            if (currentFiles.length === 0) {
                alert('No files to clear');
                return;
            }

            if (confirm(`Are you sure you want to delete all ${currentFiles.length} files?`)) {
                const deletePromises = currentFiles.map(file => 
                    fetch(`/api/files/${file.name}`, { method: 'DELETE' })
                );

                Promise.all(deletePromises)
                    .then(() => {
                        alert('All files deleted successfully!');
                        loadFiles();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete some files');
                    });
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html> 
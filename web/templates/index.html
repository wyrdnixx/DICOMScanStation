<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .scanner-card {
            transition: all 0.3s ease;
        }
        .scanner-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .file-thumbnail {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .file-thumbnail:hover {
            transform: scale(1.05);
        }
        .modal-image {
            max-width: 100%;
            max-height: 80vh;
        }
        .status-connected {
            color: #28a745;
        }
        .status-disconnected {
            color: #dc3545;
        }
        .scanner-selected {
            background-color: #e3f2fd !important;
            border-color: #2196f3 !important;
        }
        .loading {
            display: none;
        }
        .loading.show {
            display: block;
        }
        .settings-gear {
            color: #6c757d;
            transition: color 0.2s ease;
        }
        .settings-gear:hover {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Header -->
            <div class="col-12 bg-primary text-white p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-0">
                            <i class="fas fa-scanner"></i> {{.title}}
                        </h1>
                        <p class="mb-0">{{.config.WebDescription}}</p>
                    </div>
                    <div class="text-end">
                        <h5 class="mb-0">DICOMScanStation</h5>
                        <small class="text-light">(c) 2025 - Johannes Hehn - JoHeSoft</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Scanner Status -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-scanner"></i> Scanner Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="scanners-container">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p>Loading scanners...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scan Control -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-camera"></i> Scan Control</h5>
                    </div>
                    <div class="card-body">
                        <div id="scan-control">
                            <div class="text-center">
                                <p>No connected scanners available</p>
                            </div>
                        </div>
                        
                        <!-- Scan Options (initially hidden) -->
                        <div id="scan-options" style="display: none;">
                            <hr>
                            <h6><i class="fas fa-cog"></i> Scan Options</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="multiPage" checked>
                                        <label class="form-check-label" for="multiPage">
                                            Multi-page scanning
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="duplex">
                                        <label class="form-check-label" for="duplex">
                                            Duplex (both sides)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="color" checked>
                                        <label class="form-check-label" for="color">
                                            Color scanning
                                        </label>
                                    </div>
                                    <div class="mb-3">
                                        <label for="resolution" class="form-label">Resolution (DPI)</label>
                                        <select class="form-select" id="resolution">
                                            <option value="150">150 DPI</option>
                                            <option value="300" selected>300 DPI</option>
                                            <option value="600">600 DPI</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PACs-Daten -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>
                        <i class="fas fa-database"></i> PACs-Daten
                        <button type="button" class="btn btn-link btn-sm ms-2 settings-gear" onclick="showSettings()" title="View Settings">
                            <i class="fas fa-cog"></i>
                        </button>
                    </h5>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearPacsData()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
                    <div class="card-body">
                        <!-- Search Boxes -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="pacs-search-name" class="form-label">Nachname:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="pacs-search-name" placeholder="Enter patient name...">
                                    <button class="btn btn-outline-primary" type="button" onclick="searchPacsByName()">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="pacs-search-birthdate" class="form-label">Geburtsdatum:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="pacs-search-birthdate" placeholder="YYYYMMDD format...">
                                    <button class="btn btn-outline-primary" type="button" onclick="searchPacsByBirthdate()">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                            </div>                            
                        </div>

                        <!-- Search Results Table -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="pacs-results-table">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Select</th>
                                                <th>Patient ID</th>
                                                <th>Name</th>
                                                <th>Birth Date</th>
                                                <th>Gender</th>                                                
                                            </tr>
                                        </thead>
                                        <tbody id="pacs-results-body">
                                            <!-- Search results will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Send Button --> 
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="document-creator" class="form-label">Dokument Ersteller:</label>
                                    <div class="input-group">
                                                                                <input type="text" class="form-control" id="document-creator" placeholder="Enter document creator name...">
                                        <button class="btn btn-success" id="send-to-pacs-btn" onclick="sendToPacs()" disabled>
                                            <i class="fas fa-paper-plane"></i> An PACs senden
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Modal -->
                        <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="progressModalLabel">
                                            <i class="fas fa-spinner fa-spin"></i> Processing Files...
                                        </h5>
                                    </div>
                                    <div class="modal-body">
                                        <div id="progress-container">
                                            <!-- Progress items will be inserted here -->
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scanned Files -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-images"></i> Scanned Files</h5>
                        <button class="btn btn-outline-danger btn-sm" onclick="clearAllFiles()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="files-container">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p>Loading files...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Document View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center position-relative">
                    <img id="modal-image" class="modal-image" src="" alt="Document">
                    
                    <!-- Navigation buttons -->
                    <button type="button" class="btn btn-outline-primary position-absolute top-50 start-0 translate-middle-y" 
                            id="prev-image-btn" onclick="showPreviousImage()" style="z-index: 10;">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary position-absolute top-50 end-0 translate-middle-y" 
                            id="next-image-btn" onclick="showNextImage()" style="z-index: 10;">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <!-- Navigation info below image -->
                <div class="text-center mb-2">
                    <span id="image-nav-info" class="badge bg-secondary">1 of 1</span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" onclick="deleteCurrentFile()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i id="toast-icon" class="fas me-2"></i>
                <strong id="toast-title" class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div id="toast-body" class="toast-body">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">
                        <i id="confirm-icon" class="fas fa-question-circle me-2"></i>
                        <span id="confirm-title">Confirm Action</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirm-message">Are you sure you want to perform this action?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-action-btn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">
                        <i class="fas fa-cog me-2"></i> Application Settings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="settings-container">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading settings...</span>
                            </div>
                            <p>Loading settings...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFiles = [];
        let currentFilename = '';
        let currentImageIndex = -1;
        let selectedScanner = '';

        let isScanning = false;
        let scannerRefreshInterval;
        let filesRefreshInterval;

        // Toast notification function
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toast-icon');
            const toastTitle = document.getElementById('toast-title');
            const toastBody = document.getElementById('toast-body');
            
            // Set icon and color based on type
            let iconClass = 'fa-info-circle';
            let bgClass = 'bg-primary';
            
            switch(type) {
                case 'success':
                    iconClass = 'fa-check-circle';
                    bgClass = 'bg-success';
                    break;
                case 'error':
                    iconClass = 'fa-exclamation-circle';
                    bgClass = 'bg-danger';
                    break;
                case 'warning':
                    iconClass = 'fa-exclamation-triangle';
                    bgClass = 'bg-warning';
                    break;
                case 'info':
                default:
                    iconClass = 'fa-info-circle';
                    bgClass = 'bg-primary';
                    break;
            }
            
            // Update toast content
            toastIcon.className = `fas ${iconClass} me-2`;
            toastTitle.textContent = title;
            toastBody.textContent = message;
            
            // Update toast background
            toast.className = `toast ${bgClass} text-white`;
            
            // Show the toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Confirmation modal function
        function showConfirm(title, message, icon, action) {
            const confirmModal = document.getElementById('confirmModal');
            const confirmIcon = document.getElementById('confirm-icon');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmBtn = document.getElementById('confirm-action-btn');
            
            // Update modal content
            confirmIcon.className = `fas ${icon} me-2`;
            confirmTitle.textContent = title;
            confirmMessage.innerHTML = message; // Use innerHTML to render HTML content
            
            // Set up the action button
            confirmBtn.onclick = () => {
                action();
                bootstrap.Modal.getInstance(confirmModal).hide();
            };
            
            // Show the modal
            const modal = new bootstrap.Modal(confirmModal);
            modal.show();
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadScanners();
            loadFiles();
            updateSendButtonState();
            
            // Refresh data every 5 seconds
            scannerRefreshInterval = setInterval(loadScanners, 5000);
            filesRefreshInterval = setInterval(loadFiles, 5000);
        });

        function loadScanners() {
            fetch('/api/scanners')
                .then(response => response.json())
                .then(data => {
                    updateScannersUI(data.scanners);
                })
                .catch(error => {
                    console.error('Error loading scanners:', error);
                });
        }

        function updateScannersUI(scanners) {
            const container = document.getElementById('scanners-container');
            const scanControl = document.getElementById('scan-control');
            
            if (scanners.length === 0) {
                container.innerHTML = '<p class="text-muted">No scanners detected</p>';
                scanControl.innerHTML = '<p class="text-muted">No connected scanners available</p>';
                return;
            }

            let scannersHTML = '';
            let scanControlHTML = '';
            let connectedScanners = [];

            scanners.forEach(scanner => {
                const statusClass = scanner.connected ? 'status-connected' : 'status-disconnected';
                const statusIcon = scanner.connected ? 'fa-check-circle' : 'fa-times-circle';
                const isSelected = selectedScanner === scanner.device;
                const selectedClass = isSelected ? 'scanner-selected' : '';
                
                scannersHTML += `
                    <div class="scanner-card card mb-3 ${selectedClass}" onclick="selectScanner('${scanner.device}')" style="cursor: pointer;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${scanner.name}</h6>
                                    <small class="text-muted">${scanner.device}</small>
                                </div>
                                <div class="text-end">
                                    <i class="fas ${statusIcon} ${statusClass}"></i>
                                    <br>
                                    <small class="text-muted">${scanner.status}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                if (scanner.connected) {
                    connectedScanners.push(scanner);
                }
            });

            // Generate scan control based on connected scanners
            if (connectedScanners.length === 0) {
                scanControlHTML = '<p class="text-muted text-center">No connected scanners available</p>';
                document.getElementById('scan-options').style.display = 'none';
            } else if (connectedScanners.length === 1) {
                const scanner = connectedScanners[0];
                const isSelected = selectedScanner === scanner.device;
                const buttonClass = isSelected ? 'btn-primary' : 'btn-outline-primary';
                const buttonText = isSelected ? 'Selected Scanner' : 'Select Scanner';
                
                scanControlHTML = `
                    <div class="text-center">
                        <p>Ready to scan with: <strong>${scanner.name}</strong></p>
                        <button class="btn ${buttonClass} btn-lg" onclick="startScan('${scanner.device}')">
                            <i class="fas fa-camera"></i> ${buttonText}
                        </button>
                    </div>
                `;
                
                if (isSelected) {
                    document.getElementById('scan-options').style.display = 'block';
                } else {
                    document.getElementById('scan-options').style.display = 'none';
                }
            } else {
                // Multiple connected scanners
                const selectedScannerObj = connectedScanners.find(s => s.device === selectedScanner);
                if (selectedScannerObj) {
                    scanControlHTML = `
                        <div class="text-center">
                            <p>Selected scanner: <strong>${selectedScannerObj.name}</strong></p>
                            <button class="btn btn-primary btn-lg" onclick="startScan('${selectedScannerObj.device}')">
                                <i class="fas fa-camera"></i> Start Scan
                            </button>
                        </div>
                    `;
                    document.getElementById('scan-options').style.display = 'block';
                } else {
                    scanControlHTML = `
                        <div class="text-center">
                            <p class="text-muted">Click on a scanner above to select it</p>
                            <button class="btn btn-outline-secondary btn-lg" disabled>
                                <i class="fas fa-camera"></i> Select Scanner First
                            </button>
                        </div>
                    `;
                    document.getElementById('scan-options').style.display = 'none';
                }
            }

            container.innerHTML = scannersHTML;
            if (scanControlHTML) {
                scanControl.innerHTML = scanControlHTML;
            }
        }

        function loadFiles() {
            fetch('/api/files')
                .then(response => response.json())
                .then(data => {
                    currentFiles = data.files;
                    updateFilesUI(data.files);
                    updateSendButtonState();
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                });
        }

        function updateFilesUI(files) {
            const container = document.getElementById('files-container');
            
            if (isScanning) {
                container.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Scanning...</span>
                        </div>
                        <p class="mt-2">Scanning in progress...</p>
                    </div>
                `;
                return;
            }
            
            if (files.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No scanned files found</p>';
                return;
            }

            // Sort files by filename with natural number sorting
            files.sort((a, b) => {
                // Extract numbers from filenames for natural sorting
                const getNumber = (filename) => {
                    const match = filename.match(/_(\d+)\.jpg$/);
                    return match ? parseInt(match[1]) : 0;
                };
                
                const numA = getNumber(a.name);
                const numB = getNumber(b.name);
                
                return numA - numB;
            });

            let filesHTML = '<div class="row">';
            files.forEach(file => {
                filesHTML += `
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <img src="/api/files/${file.name}" 
                                     class="file-thumbnail mb-2" 
                                     onclick="viewImage('${file.name}')"
                                     alt="${file.name}">
                                <h6 class="card-title">${file.name}</h6>
                                <p class="card-text">
                                    <small class="text-muted">
                                        ${formatFileSize(file.size)}<br>
                                        ${file.modified_time}
                                    </small>
                                </p>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteFile('${file.name}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            filesHTML += '</div>';
            container.innerHTML = filesHTML;
            updateSendButtonState();
        }

        function updateSendButtonState() {
            const sendButton = document.getElementById('send-to-pacs-btn');
            const selectedPatient = document.querySelector('.pacs-radio:checked');
            const hasFiles = currentFiles && currentFiles.length > 0;
            const hasPatient = selectedPatient !== null;
            
            if (hasFiles && hasPatient) {
                sendButton.disabled = false;
                sendButton.classList.remove('btn-secondary');
                sendButton.classList.add('btn-success');
            } else {
                sendButton.disabled = true;
                sendButton.classList.remove('btn-success');
                sendButton.classList.add('btn-secondary');
            }
        }

        function selectScanner(device) {
            selectedScanner = device;
            loadScanners(); // Refresh the UI to show selection
            
            // Show scan options when a scanner is selected
            const scanOptions = document.getElementById('scan-options');
            if (scanOptions) {
                scanOptions.style.display = 'block';
            }
        }

        function startScan(device) {
            // Auto-select the scanner if none is selected
            if (!selectedScanner && device) {
                selectedScanner = device;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
            
            // Pause auto-refresh during scanning
            isScanning = true;
            clearInterval(filesRefreshInterval);

            // Get scan options
            const options = {
                multi_page: document.getElementById('multiPage').checked,
                duplex: document.getElementById('duplex').checked,
                color: document.getElementById('color').checked,
                resolution: parseInt(document.getElementById('resolution').value)
            };

            fetch('/api/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    device: device,
                    options: options
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('error', 'Scan Failed', 'Scan failed: ' + data.error);
                } else {
                    const pageText = data.pages === 1 ? 'page' : 'pages';
                    showToast('success', 'Scan Completed', `Scan completed successfully! Scanned ${data.pages} ${pageText}.`);
                    // Add a delay to ensure files are fully written before refreshing
                    setTimeout(() => {
                        loadFiles();
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'Scan Failed', 'Scan failed: ' + error.message);
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalText;
                
                // Resume auto-refresh after scanning
                isScanning = false;
                filesRefreshInterval = setInterval(loadFiles, 5000);
            });
        }

        function viewImage(filename) {
            currentFilename = filename;
            currentImageIndex = currentFiles.findIndex(file => file.name === filename);
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            document.getElementById('modal-image').src = `/api/files/${filename}`;
            updateImageNavigation();
            modal.show();
        }

        function updateImageNavigation() {
            const prevBtn = document.getElementById('prev-image-btn');
            const nextBtn = document.getElementById('next-image-btn');
            const navInfo = document.getElementById('image-nav-info');
            
            if (prevBtn && nextBtn && navInfo) {
                const totalImages = currentFiles.length;
                const currentImage = currentImageIndex + 1;
                
                // Update navigation buttons
                prevBtn.disabled = currentImageIndex <= 0;
                nextBtn.disabled = currentImageIndex >= totalImages - 1;
                
                // Update navigation info
                navInfo.textContent = `${currentImage} of ${totalImages}`;
            }
        }

        function showPreviousImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                const filename = currentFiles[currentImageIndex].name;
                currentFilename = filename;
                document.getElementById('modal-image').src = `/api/files/${filename}`;
                updateImageNavigation();
            }
        }

        function showNextImage() {
            if (currentImageIndex < currentFiles.length - 1) {
                currentImageIndex++;
                const filename = currentFiles[currentImageIndex].name;
                currentFilename = filename;
                document.getElementById('modal-image').src = `/api/files/${filename}`;
                updateImageNavigation();
            }
        }

        function deleteFile(filename) {
            showConfirm(
                'Delete File',
                `Are you sure you want to delete "${filename}"?`,
                'fa-trash',
                () => {
                    // Immediately remove the file from the UI for better responsiveness
                    currentFiles = currentFiles.filter(file => file.name !== filename);
                    updateFilesUI(currentFiles);
                    
                    fetch(`/api/files/${filename}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showToast('error', 'Delete Failed', 'Delete failed: ' + data.error);
                            // Reload files if deletion failed
                            loadFiles();
                        } else {
                            showToast('success', 'File Deleted', 'File deleted successfully!');
                            // Double-check with server to ensure UI is in sync
                            setTimeout(() => {
                                loadFiles();
                            }, 100);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('error', 'Delete Failed', 'Delete failed: ' + error.message);
                        // Reload files if deletion failed
                        loadFiles();
                    });
                }
            );
        }

        function deleteCurrentFile() {
            if (currentFilename) {
                deleteFile(currentFilename);
                bootstrap.Modal.getInstance(document.getElementById('imageModal')).hide();
            }
        }

        function clearAllFiles() {
            if (currentFiles.length === 0) {
                showToast('warning', 'No Files', 'No files to clear');
                return;
            }

            showConfirm(
                'Delete All Files',
                `Are you sure you want to delete all ${currentFiles.length} files?`,
                'fa-trash-alt',
                () => {
                    // Store the files to delete before clearing the UI
                    const filesToDelete = [...currentFiles];
                    
                    // Immediately clear the UI for better responsiveness
                    currentFiles = [];
                    updateFilesUI(currentFiles);
                    
                    const deletePromises = filesToDelete.map(file => 
                        fetch(`/api/files/${file.name}`, { method: 'DELETE' })
                    );

                    Promise.all(deletePromises)
                        .then(() => {
                            showToast('success', 'All Files Deleted', 'All files deleted successfully!');
                            // Double-check with server to ensure UI is in sync
                            setTimeout(() => {
                                loadFiles();
                            }, 100);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showToast('error', 'Delete Failed', 'Failed to delete some files');
                            // Reload files if deletion failed
                            loadFiles();
                        });
                }
            );
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // PACs functionality
        function searchPacsByName() {
            const searchTerm = document.getElementById('pacs-search-name').value.trim();
            if (!searchTerm) {
                showToast('warning', 'Search Error', 'Please enter a patient name');
                return;
            }

            // Show loading state
            const tbody = document.getElementById('pacs-results-body');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border" role="status"></div><p>Searching by name...</p></td></tr>';

            // Call the DICOM search API for name search
            fetch(`/api/dicom/search?q=${encodeURIComponent(searchTerm)}&type=name`)
                .then(response => {
                    if (!response.ok) {
                        // Read the error message from the response body
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    displayPacsResults(data.patients || []);
                    showToast('success', 'Search Complete', `Found ${data.total || 0} patients`);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    console.error('Error message:', error.message);
                    
                    // Always display the exact error message from the server
                    const errorMessage = error.message;
                    const toastMessage = error.message;
                    
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">' + errorMessage + '</td></tr>';
                    showToast('error', 'Search Failed', toastMessage);
                });
        }

        function searchPacsByBirthdate() {
            const searchTerm = document.getElementById('pacs-search-birthdate').value.trim();
            if (!searchTerm) {
                showToast('warning', 'Search Error', 'Please enter a birth date (YYYYMMDD format)');
                return;
            }

            // Validate date format (YYYYMMDD)
            if (!/^\d{8}$/.test(searchTerm)) {
                showToast('warning', 'Invalid Format', 'Please enter birth date in YYYYMMDD format (e.g., 19440831)');
                return;
            }

            // Show loading state
            const tbody = document.getElementById('pacs-results-body');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border" role="status"></div><p>Searching by birth date...</p></td></tr>';

            // Call the DICOM search API for birthdate search
            fetch(`/api/dicom/search?q=${encodeURIComponent(searchTerm)}&type=birthdate`)
                .then(response => {
                    if (!response.ok) {
                        // Read the error message from the response body
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    displayPacsResults(data.patients || []);
                    showToast('success', 'Search Complete', `Found ${data.total || 0} patients`);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    console.error('Error message:', error.message);
                    
                    // Always display the exact error message from the server
                    const errorMessage = error.message;
                    const toastMessage = error.message;
                    
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">' + errorMessage + '</td></tr>';
                    showToast('error', 'Search Failed', toastMessage);
                });
        }

        function clearPacsData() {
            // Clear search input fields
            document.getElementById('pacs-search-name').value = '';
            document.getElementById('pacs-search-birthdate').value = '';
            
            // Clear document creator field
            document.getElementById('document-creator').value = '';
            
            // Clear search results table
            const tbody = document.getElementById('pacs-results-body');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No patients found</td></tr>';
            
            // Clear any selected patient
            document.querySelectorAll('.pacs-radio').forEach(rb => rb.checked = false);
            
            // Update send button state
            updateSendButtonState();
            
            // Show confirmation toast
            showToast('success', 'Cleared', 'All PACs data has been cleared');
        }

        function displayPacsResults(results) {
            const tbody = document.getElementById('pacs-results-body');
            tbody.innerHTML = '';

            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No patients found</td></tr>';
                return;
            }

            results.forEach((patient, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="radio" class="form-check-input pacs-radio" name="selectedPatient" value="${patient.patientId}" 
                        data-name="${patient.name}" 
                        data-birthdate="${patient.birthDate}" 
                        data-gender="${patient.gender}" 
                        data-studydate="${patient.studyDate}"></td>
                    <td>${patient.patientId}</td>
                    <td>${patient.name}</td>
                    <td>${patient.birthDate}</td>
                    <td>${patient.gender}</td>
                    <td>${patient.studyDate}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners to radio buttons
            document.querySelectorAll('.pacs-radio').forEach(radio => {
                radio.addEventListener('change', updateSendButtonState);
            });
            
            // Update button state after displaying results
            updateSendButtonState();
        }

        function sendToPacs() {
            const selectedPatientRadio = document.querySelector('.pacs-radio:checked');
            const documentCreator = document.getElementById('document-creator').value.trim();

            if (!selectedPatientRadio) {
                showToast('warning', 'No Selection', 'Please select a patient');
                return;
            }

            if (!documentCreator) {
                showToast('warning', 'Missing Information', 'Please enter the document creator name');
                return;
            }

            if (currentFiles.length === 0) {
                showToast('warning', 'No Files', 'Please scan some documents first');
                return;
            }

            // Get the selected patient data from the radio button's data attributes
            const selectedPatient = {
                patientId: selectedPatientRadio.value,
                name: selectedPatientRadio.getAttribute('data-name'),
                birthDate: selectedPatientRadio.getAttribute('data-birthdate'),
                gender: selectedPatientRadio.getAttribute('data-gender'),
                studyDate: selectedPatientRadio.getAttribute('data-studydate')
            };



            // Show information box with all details
            const infoMessage = `
                <strong>PACs Upload Information:</strong><br><br>
                <strong>Patient:</strong> ${selectedPatient.name}<br>
                <strong>Patient ID:</strong> ${selectedPatient.patientId}<br>
                <strong>Birth Date:</strong> ${selectedPatient.birthDate}<br>
                <strong>Gender:</strong> ${selectedPatient.gender}<br>
                <strong>Document Creator:</strong> ${documentCreator}<br>
                <strong>Institution Name:</strong> ${documentCreator}<br>
                <strong>Files to Process:</strong> ${currentFiles.length} scanned document(s)<br><br>
                <strong>Process:</strong><br>
                1. Convert JPG files to DICOM format<br>
                2. Update DICOM files with patient data<br>
                3. Upload to PACs server<br><br>
                <em>This process will convert all scanned images in the temp folder and upload them to the PACs server.</em>
            `;

            showConfirm(
                'Send to PACs',
                infoMessage,
                'fa-paper-plane',
                () => {
                    // Show loading state
                    const button = event.target;
                    const originalText = button.innerHTML;
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                    // Show progress modal
                    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
                    progressModal.show();

                    // Call the real DICOM send API with selected patient data
                    fetch('/api/dicom/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            patientIds: [selectedPatient.patientId],
                            documentCreator: documentCreator,
                            selectedPatient: selectedPatient
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errorData => {
                                throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        button.disabled = false;
                        button.innerHTML = originalText;
                        
                        // Show progress results
                        showProgressResults(data.progress, data.success, data.total);
                        
                        // Clear selection
                        document.querySelectorAll('.pacs-radio').forEach(rb => rb.checked = false);
                    })
                    .catch(error => {
                        console.error('Send error:', error);
                        button.disabled = false;
                        button.innerHTML = originalText;
                        progressModal.hide();
                        showToast('error', 'Send Failed', 'Failed to send to PACs: ' + error.message);
                    });
                }
            );
        }

        function showProgressResults(progress, success, total) {
            const container = document.getElementById('progress-container');
            const modalTitle = document.getElementById('progressModalLabel');
            
            // Update modal title based on results
            if (success === total) {
                modalTitle.innerHTML = '<i class="fas fa-check-circle text-success"></i> Upload Complete';
            } else if (success > 0) {
                modalTitle.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Upload Partially Complete';
            } else {
                modalTitle.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Upload Failed';
            }

            // Build progress HTML
            let progressHTML = '';
            progress.forEach((item, index) => {
                const statusClass = item.status === 'completed' ? 'success' : 
                                  item.status === 'failed' ? 'danger' : 'info';
                const statusIcon = item.status === 'completed' ? 'fa-check-circle' :
                                 item.status === 'failed' ? 'fa-times-circle' :
                                 item.status === 'converting' ? 'fa-cog fa-spin' :
                                 item.status === 'updating' ? 'fa-edit' :
                                 item.status === 'sending' ? 'fa-paper-plane' :
                                 item.status === 'cleaning' ? 'fa-broom' : 'fa-circle';
                
                progressHTML += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${item.filename}</h6>
                                    <small class="text-muted">${item.message}</small>
                                </div>
                                <div class="text-end">
                                    <i class="fas ${statusIcon} text-${statusClass}"></i>
                                    <br>
                                    <small class="text-${statusClass}">${item.status.toUpperCase()}</small>
                                </div>
                            </div>
                            <div class="progress mt-2" style="height: 4px;">
                                <div class="progress-bar bg-${statusClass}" style="width: ${item.progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Add summary
            progressHTML += `
                <div class="alert alert-${success === total ? 'success' : success > 0 ? 'warning' : 'danger'} mt-3">
                    <strong>Summary:</strong> ${success} of ${total} files successfully uploaded to PACs.
                </div>
            `;
            
            // Add confirmation button if all files were successful
            if (success === total && total > 0) {
                progressHTML += `
                    <div class="alert alert-success mt-3">
                        <i class="fas fa-check-circle"></i> All files successfully uploaded to PACs!
                        <div class="mt-2">
                            <button type="button" class="btn btn-success" onclick="confirmAndReload()">
                                <i class="fas fa-check"></i> Confirm & Reload Page
                            </button>
                        </div>
                    </div>
                `;
            } else if (success > 0) {
                // Partial success - still offer reload option
                progressHTML += `
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle"></i> ${success} of ${total} files uploaded successfully.
                        <div class="mt-2">
                            <button type="button" class="btn btn-warning" onclick="confirmAndReload()">
                                <i class="fas fa-check"></i> Confirm & Reload Page
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // No success - offer reload option
                progressHTML += `
                    <div class="alert alert-danger mt-3">
                        <i class="fas fa-times-circle"></i> No files were uploaded successfully.
                        <div class="mt-2">
                            <button type="button" class="btn btn-secondary" onclick="confirmAndReload()">
                                <i class="fas fa-check"></i> Confirm & Reload Page
                            </button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = progressHTML;
        }

        function confirmAndReload() {
            // Hide the progress modal
            const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
            if (progressModal) {
                progressModal.hide();
            }
            
            // Reload the page to show updated file list
            location.reload();
        }

        // Settings functionality
        function showSettings() {
            const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
            settingsModal.show();
            loadSettings();
        }

        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    displaySettings(data);
                })
                .catch(error => {
                    console.error('Error loading settings:', error);
                    document.getElementById('settings-container').innerHTML = 
                        '<div class="alert alert-danger">Failed to load settings: ' + error.message + '</div>';
                });
        }

        function displaySettings(settings) {
            const container = document.getElementById('settings-container');
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle text-primary"></i> Application</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Name:</strong></td><td>${settings.app.name}</td></tr>
                            <tr><td><strong>Version:</strong></td><td>${settings.app.version}</td></tr>
                            <tr><td><strong>Host:</strong></td><td>${settings.app.host}</td></tr>
                            <tr><td><strong>Port:</strong></td><td>${settings.app.port}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-file-alt text-success"></i> File Storage</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Temp Directory:</strong></td><td>${settings.file_storage.temp_files_dir}</td></tr>
                            <tr><td><strong>Max File Size:</strong></td><td>${formatFileSize(settings.file_storage.max_file_size)}</td></tr>
                            <tr><td><strong>Allowed Extensions:</strong></td><td>${settings.file_storage.allowed_extensions.join(', ')}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6><i class="fas fa-scanner text-warning"></i> Scanner</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Poll Interval:</strong></td><td>${settings.scanner.poll_interval}ms</td></tr>
                            <tr><td><strong>Timeout:</strong></td><td>${settings.scanner.timeout}ms</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-globe text-info"></i> Web Interface</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Title:</strong></td><td>${settings.web.title}</td></tr>
                            <tr><td><strong>Description:</strong></td><td>${settings.web.description}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6><i class="fas fa-list text-secondary"></i> Logging</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Level:</strong></td><td>${settings.logging.level}</td></tr>
                            <tr><td><strong>Format:</strong></td><td>${settings.logging.format}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-database text-danger"></i> DICOM Configuration</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Local AE Title:</strong></td><td>${settings.dicom.local_ae_title}</td></tr>
                            <tr><td><strong>Query AE Title:</strong></td><td>${settings.dicom.query_ae_title}</td></tr>
                            <tr><td><strong>Store AE Title:</strong></td><td>${settings.dicom.store_ae_title}</td></tr>
                            <tr><td><strong>Remote Host:</strong></td><td>${settings.dicom.remote_host}</td></tr>
                            <tr><td><strong>FindSCU Port:</strong></td><td>${settings.dicom.findscu_port}</td></tr>
                            <tr><td><strong>StoreSCU Port:</strong></td><td>${settings.dicom.storescu_port}</td></tr>
                            <tr><td><strong>DCMTK Path:</strong></td><td>${settings.dicom.dcmtk_path}</td></tr>
                            <tr><td><strong>Station Name:</strong></td><td>${settings.dicom.station_name}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Note:</strong> These settings are loaded from environment variables and the .env file. 
                    To modify these settings, please update your .env file and restart the application.
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Enter key handlers for search fields
        document.addEventListener('DOMContentLoaded', function() {
            // Add Enter key handlers for search fields
            const nameSearchField = document.getElementById('pacs-search-name');
            const birthdateSearchField = document.getElementById('pacs-search-birthdate');

            if (nameSearchField) {
                nameSearchField.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        searchPacsByName();
                    }
                });
            }

            if (birthdateSearchField) {
                birthdateSearchField.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        searchPacsByBirthdate();
                    }
                });
            }

            // Add keyboard navigation for image modal
            document.addEventListener('keydown', function(event) {
                const imageModal = document.getElementById('imageModal');
                if (imageModal && imageModal.classList.contains('show')) {
                    switch(event.key) {
                        case 'ArrowLeft':
                            event.preventDefault();
                            showPreviousImage();
                            break;
                        case 'ArrowRight':
                            event.preventDefault();
                            showNextImage();
                            break;
                        case 'Escape':
                            event.preventDefault();
                            bootstrap.Modal.getInstance(imageModal).hide();
                            break;
                    }
                }
            });
        });
    </script>
</body>
</html> 